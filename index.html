<!DOCTYPE html>
<html lang="ru">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Генератор CSV</title>
    <style>
        body {
            font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
        }

        #message {
            display: none;
            color: green;
            font-weight: bold;
        }

        button {
            width: 100%;
            padding: 5px;
            background-color: black;
            color: #fff;
        }
        ul {
            padding: 20px;
        }
        li {
            list-style: auto;
            padding-top: 15px;
            border-bottom: 3px solid black;
            margin-bottom: 10px;
        }
    </style>
</head>

<body>
    <div style="max-width: 600px; margin: 0 auto; padding: 20px;">
        <h1>Генератор CSV</h1>
        <textarea id="fileContent" rows="10" style="width: 100%;" placeholder="Вставьте содержимое файла здесь"></textarea>
        <button onclick="processFile()">Сгенерировать CSV</button>
        <hr>
        <h2>Сгенерированный CSV:</h2>
        <button onclick="copyToClipboard()">Копировать всё</button>
        <h3 id="message">Успешно скопировано в буфер обмена!</h3>
        <ul id="outputList"></ul>
    </div>

    <script>
        function processFile() {
            const fileContent = document.getElementById('fileContent').value;
            const lines = fileContent.split('\n');
            const outputList = document.getElementById('outputList');

            // Очистка списка перед добавлением новых элементов
            outputList.innerHTML = '';

            let previousATMW = null;

            lines.forEach((line) => {
                const processed = parseLine(line.trim(), previousATMW); // Убираем лишние пробелы по краям строки
                if (processed) {
                    previousATMW = processed.atmw || previousATMW; // Обновляем значение ATMW
                    if (processed.dataType !== 'WORD') {
                        const listItem = document.createElement('li');
                        listItem.textContent = processed.csvContent;
                        outputList.appendChild(listItem);
                    }
                }
            });
        }

        function parseLine(line, previousATMW) {
            const colonIndex = line.indexOf(':');
            if (colonIndex !== -1) {
                const variableName = line.substring(0, colonIndex).replace(/\{[^}]*\}/g, '').trim();
                let dataTypeString = line.substring(colonIndex + 1).trim();

                let dataType = 'Bit'; // По умолчанию тип данных Bit
                let subDataType = 'M';
                let Perem = 'True'; // По умолчанию True
                let atmw = previousATMW; // Используем предыдущее значение ATMW

                // Извлечение значения ATMW
                const atmwMatch = line.match(/\{AT %MW(\d+)\}/);
                if (atmwMatch) {
                    atmw = atmwMatch[1];
                }

                if (dataTypeString.includes('BOOL')) {
                    dataType = 'Word';
                    subDataType = 'MW';
                    Perem = 'True';
                } else if (dataTypeString.includes('UINT') || dataTypeString.includes('REAL') || dataTypeString.includes('TIME')) {
                    dataType = 'Bit';
                    subDataType = 'M';
                    Perem = 'False';
                } else {
                    return null; // Возвращаем null, если тип данных не определен
                }

                // Формирование CSV строки
                if (dataType !== 'WORD') {
                    const uuid = () => 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, c => {
                        const r = Math.random() * 16 | 0;
                        const v = c === 'x' ? r : (r & 0x3 | 0x8);
                        return v.toString(16);
                    });

                    // Здесь исправляем строку csvContent, чтобы включить адрес
                    const csvContent = `${uuid()},${variableName},HMI N+1:[Ethernet ПЛК:Schneider MODBUS_TCP],%${subDataType},${dataType},${atmw},False,${atmw},0,0,False,${Perem},,,,,,,,,,,,,334,,,1`;
                    return { csvContent, dataType, atmw };
                }
            }

            return null;
        }

        function copyToClipboard() {
            const listItems = document.querySelectorAll('#outputList li');
            const allText = Array.from(listItems).map(item => item.textContent).join('\n');
            navigator.clipboard.writeText(allText).then(function () {
                document.getElementById('message').style.display = 'block';
                setTimeout(() => {
                    document.getElementById('message').style.display = 'none';
                }, 3000);
            }, function (err) {
                alert('Не удалось скопировать: ' + err);
            });
        }
    </script>
</body>

</html>
